---
title: "Data Anlaysis Exercise - Module 4"
author: "Aidan Troha &"
output:
  html_document:
    toc: FALSE
---

This data, from NCHS, shows provisional death counts for the US. These data are obtained from the CDC website, data.CDC.org. Within, you can find COVID-19-related deaths separated by education, age, sex, and race. Data was collected as early as January 1st, 2020 and continued until January 30th, 2021. The data was last updated February 3rd, 2021.
```{r}
library(readr)
library(tidyverse)
library(skimr)
library(broom)
library(agricolae)
library(stringr)
```

```{r}
# Imports the raw data set. The original data set is a CSV file.
raw_data <- read_csv("data/AH_Provisional_COVID-19_Deaths_by_Educational_Attainment__Race__Sex__and_Age.csv")
# Shows the classes of the variables.
glimpse(raw_data)
# Creates a new data set with the variables we would like to keep. In an effort to be 
# more user friendly, the variable names have been converted to all lowercase with no 
# spaces. Also, some variables have been converted to factor classes.
new_data <- raw_data %>%
    # Changes the variable names and makes some factors.
           mutate(education_level = as.factor(`Education Level`),
                  race_origin = as.factor(`Race or Hispanic Origin`),
                  sex = as.factor(`Sex`),
                  age_group = as.factor(`Age Group`),
                  covid_deaths = `COVID-19 Deaths`,
                  total_deaths = `Total Deaths`
                  ) %>%
    # Pushes only the properly formatted variables to the new data set.
           select(education_level,race_origin,sex,age_group,covid_deaths,total_deaths)
# Shows a summary of the variables included in the dataset.
glimpse(new_data)
summary(new_data)
```

#this section is added by Weifan

```{r}
#exploration of the relationship between sex, age, and covid deaths
#checking the missing data
head(new_data)
skim(new_data)
#there is no missing data, so we don't need to drop anything. Now, summarize the covid_deaths by sex and age
sex_age_cov=new_data%>%
  select(sex,covid_deaths,age_group)%>%
    group_by(sex,age_group)%>%
  summarise(total=sum(covid_deaths))
sex_age_cov
```
```{r}
#plotting
sex_age_cov%>%
  ggplot(aes(x=age_group,y=total,fill=sex))+
  geom_bar(stat="identity",color="blue",position=position_dodge())+
  labs(title="Numbers of covid deaths at different age groups",y="covid death")+
  theme_classic()

  
```
#fitting models using sex and age separately to predict covid deaths
```{r}
#using sex to predict covid death
sex_cov_model=aov(covid_deaths~sex,data=new_data)
#omnibus test
anova(sex_cov_model)
#since there p=0.878, there is no significant difference in the numbers of covid-death between male and female

#using age_group to predict covid death
age_cov_model=aov(covid_deaths~age_group,data=new_data)
#omnibus test
anova(age_cov_model)
#since p-value is <0.001, there is significant difference between age groups. using fisher's least significant difference to do post hoc analysis
lsdTest=LSD.test(age_cov_model,"age_group")
lsdTest
#according to the analysis, the the number of covid deaths in 65 years and over is significantly higher than that in other age groups
```
```{r}
summary(new_data)
#since 25% of education level is unknown, I will not analyze this variable
#exploration of the relationship between ethnicity and proportion of covid death in total death
#change the lengthy level names of race variable, change the race variable to factor
race_cov=new_data%>%
  mutate(race_origin=case_when(race_origin=="Non-Hispanic American Indian or Alaska Native"~"Indian/Alaska Native" ,race_origin=="Non-Hispanic Asian"~"Asian", race_origin=="Non-Hispanic Black"~"Black",race_origin=="Non-Hispanic Native Hawaiian or Other Pacific Islander"~"Native Islander", race_origin=="Non-Hispanic White"~"white",race_origin=="Hispanic"~"Hispanic"))%>%
  mutate(race_origin=as.factor(race_origin))%>%
  group_by(race_origin)%>%
  summarise(covid_deaths1=sum(covid_deaths),total_deaths1=sum(total_deaths))%>%
  mutate(prop=covid_deaths1/total_deaths1)
glimpse(race_cov)
levels(race_cov$race_origin)
#plotting
race_cov%>%
  ggplot(aes(x=race_origin,y=prop))+
  geom_col()+
  scale_x_discrete()+
  labs(x="races",y="the proportion",title="The proportion of deaths caused by coronavirus in total deaths among races")+
  theme_classic()
 
```
take a look at absolute value of covid death among races
```{r}
race_cov2=new_data%>%
  mutate(race_origin=case_when(race_origin=="Non-Hispanic American Indian or Alaska Native"~"Indian/Alaska Native" ,race_origin=="Non-Hispanic Asian"~"Asian", race_origin=="Non-Hispanic Black"~"Black",race_origin=="Non-Hispanic Native Hawaiian or Other Pacific Islander"~"Native Islander", race_origin=="Non-Hispanic White"~"white",race_origin=="Hispanic"~"Hispanic"))%>%
  mutate(race_origin=as.factor(race_origin))%>%
  group_by(race_origin)%>%
  summarise(covid_deaths=sum(covid_deaths))
#plotting
race_cov2%>%
  ggplot(aes(x=race_origin,y=covid_deaths))+
  geom_col()+
  scale_x_discrete()+
  scale_y_log10()+
  labs(x="races",y="covid deaths numbers",title="absolute counts of covid-related deaths among races")+
  theme_classic()
```
Absolute covid-related death population was highest in American whites, however, the proportion of Covid-associated deaths was lowest in American white. 

